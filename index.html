<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì—Ä–∞—Ñ–∏–∫ –æ—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç–∏</title>

    <!-- PWA –º–µ—Ç–∞—Ç–µ–≥–∏ -->
    <meta name="theme-color" content="#1a237e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="–û—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å">

    <!-- –ò–∫–æ–Ω–∫–∞ (emoji —Å–æ–ª–Ω—Ü–µ) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚òÄÔ∏è</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚òÄÔ∏è</text></svg>">

    <link rel="manifest" href="manifest.json">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #1a237e;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
        }

        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-location {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .btn-download {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            font-size: 14px;
            padding: 10px;
        }

        .download-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        #result {
            margin-top: 30px;
            display: none;
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
        }

        td {
            padding: 10px 8px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }

        .polar-day {
            background-color: #fff9c4 !important;
        }

        .polar-night {
            background-color: #e0e0e0 !important;
        }

        .info-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #555;
        }

        .info-value {
            color: #333;
        }

        .alert {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }

        .error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            display: none;
        }

        .success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            .button-group {
                grid-template-columns: 1fr;
            }

            th, td {
                padding: 8px 5px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚òÄÔ∏è –ì—Ä–∞—Ñ–∏–∫ –æ—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç–∏</h1>
        <p class="subtitle">–†–∞—Å—á–µ—Ç —Å—É–º–µ—Ä–µ–∫ –∏ –ø–æ–ª—è—Ä–Ω—ã—Ö –¥–Ω–µ–π/–Ω–æ—á–µ–π</p>

        <div class="input-group">
            <label>üìç –®–∏—Ä–æ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 59.93 –¥–ª—è –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–∞)</label>
            <input type="number" id="latitude" step="0.0001" placeholder="59.93" value="59.93">
        </div>

        <div class="input-group">
            <label>üìç –î–æ–ª–≥–æ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 30.34 –¥–ª—è –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–∞)</label>
            <input type="number" id="longitude" step="0.0001" placeholder="30.34" value="30.34">
        </div>

        <div class="row">
            <div class="input-group">
                <label>üìÖ –ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞</label>
                <input type="date" id="startDate">
            </div>

            <div class="input-group">
                <label>üìÖ –ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞</label>
                <input type="date" id="endDate">
            </div>
        </div>

        <div class="button-group">
            <button class="btn-location" onclick="getLocation()">üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
            <button onclick="calculateLight()">üîç –ü–æ—Å—Ç—Ä–æ–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
        </div>

        <div class="error" id="error"></div>
        <div class="success" id="success"></div>

        <div id="result">
            <div class="info-card" id="locationInfo" style="display:none;">
                <h3 style="margin-bottom: 10px; color: #1a237e;">üìç –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</h3>
                <div id="locationDetails"></div>
            </div>

            <div class="info-card" id="polarInfo" style="display:none;">
                <h3 style="margin-bottom: 10px; color: #1a237e;">‚ö†Ô∏è –û—Å–æ–±—ã–µ –ø–µ—Ä–∏–æ–¥—ã</h3>
                <div id="polarDetails"></div>
            </div>

            <div class="download-group">
                <button class="btn-download" onclick="downloadCSV()">üì• –°–∫–∞—á–∞—Ç—å CSV</button>
                <button class="btn-download" onclick="downloadExcel()">üì• –°–∫–∞—á–∞—Ç—å Excel</button>
            </div>

            <div class="table-container">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞</th>
                            <th>–ê—Å—Ç—Ä. —É—Ç—Ä–æ</th>
                            <th>–ù–∞–≤–∏–≥. —É—Ç—Ä–æ</th>
                            <th>–ì—Ä–∞–∂–¥. —É—Ç—Ä–æ</th>
                            <th>–í–æ—Å—Ö–æ–¥</th>
                            <th>–ó–∞—Ö–æ–¥</th>
                            <th>–ì—Ä–∞–∂–¥. –≤–µ—á–µ—Ä</th>
                            <th>–ù–∞–≤–∏–≥. –≤–µ—á–µ—Ä</th>
                            <th>–ê—Å—Ç—Ä. –≤–µ—á–µ—Ä</th>
                            <th>–¢–∏–ø –¥–Ω—è</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- SunCalc –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ (–≤—Å—Ç—Ä–æ–µ–Ω–∞) -->
    <script>
    /*
     (c) 2011-2015, Vladimir Agafonkin
     SunCalc is a JavaScript library for calculating sun/moon position and light phases.
     https://github.com/mourner/suncalc
    */
    (function () { 'use strict';
    var PI = Math.PI, sin = Math.sin, cos = Math.cos, tan = Math.tan, asin = Math.asin, atan = Math.atan2, acos = Math.acos, rad = PI / 180;
    var dayMs = 1000 * 60 * 60 * 24, J1970 = 2440588, J2000 = 2451545;
    function toJulian(date) { return date.valueOf() / dayMs - 0.5 + J1970; }
    function fromJulian(j)  { return new Date((j + 0.5 - J1970) * dayMs); }
    function toDays(date)   { return toJulian(date) - J2000; }
    var e = rad * 23.4397;
    function rightAscension(l, b) { return atan(sin(l) * cos(e) - tan(b) * sin(e), cos(l)); }
    function declination(l, b)    { return asin(sin(b) * cos(e) + cos(b) * sin(e) * sin(l)); }
    function azimuth(H, phi, dec)  { return atan(sin(H), cos(H) * sin(phi) - tan(dec) * cos(phi)); }
    function altitude(H, phi, dec) { return asin(sin(phi) * sin(dec) + cos(phi) * cos(dec) * cos(H)); }
    function siderealTime(d, lw) { return rad * (280.16 + 360.9856235 * d) - lw; }
    function astroRefraction(h) {
        if (h < 0) h = 0;
        return 0.0002967 / Math.tan(h + 0.00312536 / (h + 0.08901179));
    }
    function solarMeanAnomaly(d) { return rad * (357.5291 + 0.98560028 * d); }
    function eclipticLongitude(M) {
        var C = rad * (1.9148 * sin(M) + 0.02 * sin(2 * M) + 0.0003 * sin(3 * M)),
            P = rad * 102.9372;
        return M + C + P + PI;
    }
    function sunCoords(d) {
        var M = solarMeanAnomaly(d), L = eclipticLongitude(M);
        return { dec: declination(L, 0), ra: rightAscension(L, 0) };
    }
    var SunCalc = {};
    SunCalc.getPosition = function (date, lat, lng) {
        var lw  = rad * -lng, phi = rad * lat, d   = toDays(date),
            c  = sunCoords(d), H  = siderealTime(d, lw) - c.ra;
        return {
            azimuth: azimuth(H, phi, c.dec),
            altitude: altitude(H, phi, c.dec)
        };
    };
    var times = SunCalc.times = [
        [-0.833, 'sunrise',       'sunset'      ],
        [  -0.3, 'sunriseEnd',    'sunsetStart' ],
        [    -6, 'dawn',          'dusk'        ],
        [   -12, 'nauticalDawn',  'nauticalDusk'],
        [   -18, 'nightEnd',      'night'       ],
        [     6, 'goldenHourEnd', 'goldenHour'  ]
    ];
    SunCalc.addTime = function (angle, riseName, setName) {
        times.push([angle, riseName, setName]);
    };
    var J0 = 0.0009;
    function julianCycle(d, lw) { return Math.round(d - J0 - lw / (2 * PI)); }
    function approxTransit(Ht, lw, n) { return J0 + (Ht + lw) / (2 * PI) + n; }
    function solarTransitJ(ds, M, L)  { return J2000 + ds + 0.0053 * sin(M) - 0.0069 * sin(2 * L); }
    function hourAngle(h, phi, d) { return acos((sin(h) - sin(phi) * sin(d)) / (cos(phi) * cos(d))); }
    function observerAngle(height) { return -2.076 * Math.sqrt(height) / 60; }
    function getSetJ(h, lw, phi, dec, n, M, L) {
        var w = hourAngle(h, phi, dec), a = approxTransit(w, lw, n);
        return solarTransitJ(a, M, L);
    }
    SunCalc.getTimes = function (date, lat, lng, height) {
        height = height || 0;
        var lw = rad * -lng, phi = rad * lat,
            dh = observerAngle(height),
            d = toDays(date), n = julianCycle(d, lw), ds = approxTransit(0, lw, n),
            M = solarMeanAnomaly(ds), L = eclipticLongitude(M), dec = declination(L, 0),
            Jnoon = solarTransitJ(ds, M, L),
            i, len, time, h0, Jset, Jrise;
        var result = {
            solarNoon: fromJulian(Jnoon),
            nadir: fromJulian(Jnoon - 0.5)
        };
        for (i = 0, len = times.length; i < len; i += 1) {
            time = times[i];
            h0 = (time[0] + dh) * rad;
            Jset = getSetJ(h0, lw, phi, dec, n, M, L);
            Jrise = Jnoon - (Jset - Jnoon);
            result[time[1]] = fromJulian(Jrise);
            result[time[2]] = fromJulian(Jset);
        }
        return result;
    };
    if (typeof exports === 'object' && typeof module !== 'undefined') module.exports = SunCalc;
    else if (typeof define === 'function' && define.amd) define(SunCalc);
    else window.SunCalc = SunCalc;
    }());
    </script>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        let tableData = [];
        let currentLat = 0;
        let currentLon = 0;

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        window.onload = function() {
            const today = new Date();
            const nextYear = new Date(today);
            nextYear.setFullYear(today.getFullYear() + 1);

            document.getElementById('startDate').value = today.toISOString().split('T')[0];
            document.getElementById('endDate').value = nextYear.toISOString().split('T')[0];

            // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(function(err) {
                    console.log('Service Worker registration failed: ', err);
                });
            }
        };

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
        function getLocation() {
            const errorDiv = document.getElementById('error');
            const successDiv = document.getElementById('success');

            if (!navigator.geolocation) {
                errorDiv.textContent = '‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º';
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
                return;
            }

            errorDiv.style.display = 'none';
            successDiv.textContent = 'üìç –û–ø—Ä–µ–¥–µ–ª—è—é –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...';
            successDiv.style.display = 'block';

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude.toFixed(4);
                    const lon = position.coords.longitude.toFixed(4);

                    document.getElementById('latitude').value = lat;
                    document.getElementById('longitude').value = lon;

                    successDiv.textContent = `‚úÖ –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ: ${lat}, ${lon}`;

                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç—Ä–æ–∏–º —Ç–∞–±–ª–∏—Ü—É
                    setTimeout(() => {
                        calculateLight();
                    }, 500);
                },
                function(error) {
                    let errorMsg = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. ';
                    if (error.code === 1) {
                        errorMsg += '–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Safari.';
                    } else if (error.code === 2) {
                        errorMsg += '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.';
                    } else {
                        errorMsg += '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è.';
                    }
                    errorDiv.textContent = errorMsg;
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                }
            );
        }

        function formatTime(date) {
            if (!date || isNaN(date.getTime())) return '‚Äî';
            return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        }

        function formatTimeForExport(date) {
            if (!date || isNaN(date.getTime())) return '';
            return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function calculateLight() {
            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);
            const startDateInput = document.getElementById('startDate').value;
            const endDateInput = document.getElementById('endDate').value;

            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            const errorDiv = document.getElementById('error');
            const successDiv = document.getElementById('success');

            if (isNaN(lat) || lat < -90 || lat > 90) {
                errorDiv.textContent = '‚ùå –®–∏—Ä–æ—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç -90 –¥–æ 90';
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
                return;
            }
            if (isNaN(lon) || lon < -180 || lon > 180) {
                errorDiv.textContent = '‚ùå –î–æ–ª–≥–æ—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç -180 –¥–æ 180';
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
                return;
            }
            if (!startDateInput || !endDateInput) {
                errorDiv.textContent = '‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é –∏ –∫–æ–Ω–µ—á–Ω—É—é –¥–∞—Ç—É';
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
                return;
            }

            const startDate = new Date(startDateInput + 'T00:00:00');
            const endDate = new Date(endDateInput + 'T00:00:00');

            if (startDate >= endDate) {
                errorDiv.textContent = '‚ùå –ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –∫–æ–Ω–µ—á–Ω–æ–π';
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
                return;
            }

            const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            if (daysDiff > 366) {
                errorDiv.textContent = '‚ùå –ü–µ—Ä–∏–æ–¥ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å –æ–¥–∏–Ω –≥–æ–¥ (366 –¥–Ω–µ–π)';
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
                return;
            }

            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            currentLat = lat;
            currentLon = lon;

            // –í—ã—á–∏—Å–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
            tableData = [];
            const polarInfo = [];
            let currentDate = new Date(startDate);

            while (currentDate <= endDate) {
                const times = SunCalc.getTimes(currentDate, lat, lon);
                const dateStr = currentDate.toISOString().split('T')[0];

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç–∏
                let type = '–û–±—ã—á–Ω—ã–π';
                let rowClass = '';

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –≤–æ—Å—Ö–æ–¥–∞/–∑–∞–∫–∞—Ç–∞
                const sunriseValid = times.sunrise && !isNaN(times.sunrise.getTime());
                const sunsetValid = times.sunset && !isNaN(times.sunset.getTime());

                if (!sunriseValid || !sunsetValid) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã—Å–æ—Ç—É —Å–æ–ª–Ω—Ü–∞ –≤ –ø–æ–ª–¥–µ–Ω—å
                    const noonPos = SunCalc.getPosition(times.solarNoon, lat, lon);
                    const altitudeDeg = noonPos.altitude * 180 / Math.PI;

                    if (altitudeDeg > 0) {
                        type = '–ü–æ–ª—è—Ä–Ω—ã–π –¥–µ–Ω—å';
                        rowClass = 'polar-day';
                    } else {
                        type = '–ü–æ–ª—è—Ä–Ω–∞—è –Ω–æ—á—å';
                        rowClass = 'polar-night';
                    }
                }

                tableData.push({
                    date: dateStr,
                    nightEnd: times.nightEnd,
                    nauticalDawn: times.nauticalDawn,
                    dawn: times.dawn,
                    sunrise: times.sunrise,
                    sunset: times.sunset,
                    dusk: times.dusk,
                    nauticalDusk: times.nauticalDusk,
                    night: times.night,
                    type: type,
                    rowClass: rowClass
                });

                currentDate.setDate(currentDate.getDate() + 1);
            }

            // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–∏–æ–¥—ã –ø–æ–ª—è—Ä–Ω—ã—Ö –¥–Ω–µ–π/–Ω–æ—á–µ–π
            let currentPolar = null;
            tableData.forEach((d, i) => {
                if (d.type !== '–û–±—ã—á–Ω—ã–π') {
                    if (!currentPolar || currentPolar.type !== d.type) {
                        if (currentPolar) polarInfo.push(currentPolar);
                        currentPolar = { type: d.type, start: d.date, end: d.date };
                    } else {
                        currentPolar.end = d.date;
                    }
                } else {
                    if (currentPolar) {
                        polarInfo.push(currentPolar);
                        currentPolar = null;
                    }
                }
            });
            if (currentPolar) polarInfo.push(currentPolar);

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            document.getElementById('result').style.display = 'block';

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            tableData.forEach(d => {
                const row = tbody.insertRow();
                row.className = d.rowClass;

                row.insertCell(0).textContent = d.date;
                row.insertCell(1).textContent = formatTime(d.nightEnd);
                row.insertCell(2).textContent = formatTime(d.nauticalDawn);
                row.insertCell(3).textContent = formatTime(d.dawn);
                row.insertCell(4).textContent = formatTime(d.sunrise);
                row.insertCell(5).textContent = formatTime(d.sunset);
                row.insertCell(6).textContent = formatTime(d.dusk);
                row.insertCell(7).textContent = formatTime(d.nauticalDusk);
                row.insertCell(8).textContent = formatTime(d.night);
                row.insertCell(9).textContent = d.type;
            });

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏
            const locationInfoDiv = document.getElementById('locationInfo');
            const locationDetailsDiv = document.getElementById('locationDetails');
            locationInfoDiv.style.display = 'block';
            locationDetailsDiv.innerHTML = `
                <div class="info-row">
                    <span class="info-label">–®–∏—Ä–æ—Ç–∞</span>
                    <span class="info-value">${lat}¬∞</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–î–æ–ª–≥–æ—Ç–∞</span>
                    <span class="info-value">${lon}¬∞</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–ü–µ—Ä–∏–æ–¥</span>
                    <span class="info-value">${tableData[0].date} ‚Äî ${tableData[tableData.length-1].date}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–í—Å–µ–≥–æ –¥–Ω–µ–π</span>
                    <span class="info-value">${tableData.length}</span>
                </div>
            `;

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—è—Ä–Ω—ã—Ö –ø–µ—Ä–∏–æ–¥–∞—Ö
            const polarInfoDiv = document.getElementById('polarInfo');
            const polarDetailsDiv = document.getElementById('polarDetails');
            if (polarInfo.length > 0) {
                polarInfoDiv.style.display = 'block';
                polarDetailsDiv.innerHTML = polarInfo.map(p => {
                    const icon = p.type === '–ü–æ–ª—è—Ä–Ω—ã–π –¥–µ–Ω—å' ? 'üåû' : 'üåë';
                    const days = Math.ceil((new Date(p.end) - new Date(p.start)) / (1000 * 60 * 60 * 24)) + 1;
                    return `<div class="info-row">
                        <span class="info-label">${icon} ${p.type} (${days} –¥–Ω.)</span>
                        <span class="info-value">${p.start} ‚Äî ${p.end}</span>
                    </div>`;
                }).join('');
            } else {
                polarInfoDiv.style.display = 'none';
            }

            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
            document.getElementById('result').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ CSV
        function downloadCSV() {
            if (tableData.length === 0) {
                alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ—Å—Ç—Ä–æ–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É');
                return;
            }

            // –§–æ—Ä–º–∏—Ä—É–µ–º CSV —Å BOM –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Excel
            let csv = 'Ôªø'; // BOM –¥–ª—è UTF-8
            csv += '–î–∞—Ç–∞;–ê—Å—Ç—Ä–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ —Å—É–º–µ—Ä–∫–∏ —É—Ç—Ä–æ;–ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å—É–º–µ—Ä–∫–∏ —É—Ç—Ä–æ;–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–µ —Å—É–º–µ—Ä–∫–∏ —É—Ç—Ä–æ;–í–æ—Å—Ö–æ–¥;–ó–∞—Ö–æ–¥;–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–µ —Å—É–º–µ—Ä–∫–∏ –≤–µ—á–µ—Ä;–ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å—É–º–µ—Ä–∫–∏ –≤–µ—á–µ—Ä;–ê—Å—Ç—Ä–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ —Å—É–º–µ—Ä–∫–∏ –≤–µ—á–µ—Ä;–¢–∏–ø –¥–Ω—è
';

            tableData.forEach(d => {
                csv += `${d.date};`;
                csv += `${formatTimeForExport(d.nightEnd)};`;
                csv += `${formatTimeForExport(d.nauticalDawn)};`;
                csv += `${formatTimeForExport(d.dawn)};`;
                csv += `${formatTimeForExport(d.sunrise)};`;
                csv += `${formatTimeForExport(d.sunset)};`;
                csv += `${formatTimeForExport(d.dusk)};`;
                csv += `${formatTimeForExport(d.nauticalDusk)};`;
                csv += `${formatTimeForExport(d.night)};`;
                csv += `${d.type}
`;
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö –≤ –∫–æ–Ω—Ü–µ
            csv += `
–®–∏—Ä–æ—Ç–∞;${currentLat}
`;
            csv += `–î–æ–ª–≥–æ—Ç–∞;${currentLon}
`;

            // –°–æ–∑–¥–∞—ë–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            const filename = `osveshchennost_${currentLat}_${currentLon}_${tableData[0].date}.csv`;

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ Excel (HTML-—Ç–∞–±–ª–∏—Ü–∞ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .xls)
        function downloadExcel() {
            if (tableData.length === 0) {
                alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ—Å—Ç—Ä–æ–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É');
                return;
            }

            // –°–æ–∑–¥–∞—ë–º HTML-—Ç–∞–±–ª–∏—Ü—É –¥–ª—è Excel
            let html = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">';
            html += '<head><meta charset="UTF-8"><style>table { border-collapse: collapse; } td, th { border: 1px solid black; padding: 5px; }</style></head><body>';
            html += '<table>';

            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            html += '<tr style="background-color: #667eea; color: white; font-weight: bold;">';
            html += '<td>–î–∞—Ç–∞</td>';
            html += '<td>–ê—Å—Ç—Ä. —É—Ç—Ä–æ</td>';
            html += '<td>–ù–∞–≤–∏–≥. —É—Ç—Ä–æ</td>';
            html += '<td>–ì—Ä–∞–∂–¥. —É—Ç—Ä–æ</td>';
            html += '<td>–í–æ—Å—Ö–æ–¥</td>';
            html += '<td>–ó–∞—Ö–æ–¥</td>';
            html += '<td>–ì—Ä–∞–∂–¥. –≤–µ—á–µ—Ä</td>';
            html += '<td>–ù–∞–≤–∏–≥. –≤–µ—á–µ—Ä</td>';
            html += '<td>–ê—Å—Ç—Ä. –≤–µ—á–µ—Ä</td>';
            html += '<td>–¢–∏–ø –¥–Ω—è</td>';
            html += '</tr>';

            // –î–∞–Ω–Ω—ã–µ
            tableData.forEach(d => {
                const bgColor = d.rowClass === 'polar-day' ? '#fff9c4' : 
                               d.rowClass === 'polar-night' ? '#e0e0e0' : 'white';
                html += `<tr style="background-color: ${bgColor}">`;
                html += `<td>${d.date}</td>`;
                html += `<td>${formatTimeForExport(d.nightEnd)}</td>`;
                html += `<td>${formatTimeForExport(d.nauticalDawn)}</td>`;
                html += `<td>${formatTimeForExport(d.dawn)}</td>`;
                html += `<td>${formatTimeForExport(d.sunrise)}</td>`;
                html += `<td>${formatTimeForExport(d.sunset)}</td>`;
                html += `<td>${formatTimeForExport(d.dusk)}</td>`;
                html += `<td>${formatTimeForExport(d.nauticalDusk)}</td>`;
                html += `<td>${formatTimeForExport(d.night)}</td>`;
                html += `<td>${d.type}</td>`;
                html += '</tr>';
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            html += '<tr><td colspan="10"></td></tr>';
            html += `<tr><td><b>–®–∏—Ä–æ—Ç–∞</b></td><td colspan="9">${currentLat}¬∞</td></tr>`;
            html += `<tr><td><b>–î–æ–ª–≥–æ—Ç–∞</b></td><td colspan="9">${currentLon}¬∞</td></tr>`;

            html += '</table></body></html>';

            // –°–æ–∑–¥–∞—ë–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
            const blob = new Blob([html], { type: 'application/vnd.ms-excel;charset=utf-8' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            const filename = `osveshchennost_${currentLat}_${currentLon}_${tableData[0].date}.xls`;

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>